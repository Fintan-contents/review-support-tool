# getpr

プルリクエスト/マージリクエストからコメントを取得してCSVファイルへ書き出すコマンドラインプログラム。
GitHub、GitLab、GitBucketへ対応している。

プルリクエスト/マージリクエストからコメントを取得している手段は次の通り。

- GitHub: GraphQL API
- GitLab: REST API
- GitBucket: DOM操作(※)

※必要な情報を取得するためのAPIが実装されていないため、DOM操作を行っている

## ビルド方法

```bash
go build -o getpr.exe cmd\main.go
```

Windows以外の場合はこちらのコマンド。

```bash
go build -o getpr cmd/main.go
```

## 仕様

### 設定

`getpr.exe --help`を参照。

### CSVファイル仕様

#### 1行目

| 順番 | 項目名            | 説明                         |
| ---- | ----------------- | ---------------------------- |
| 1    | `additions`       | 追加行数。GitBucketは常に0。 |
| 2    | `deletions`       | 削除行数。GitBucketは常に0。 |
| 3    | `reviewDate`      | レビュー日付。               |
| 3    | `reviewStartTime` | 開始時刻。                   |
| 3    | `reviewEndTime`   | 終了時刻。                   |
| 3    | `reviewMinutes`   | レビュー時間。               |

- 追加行数・削除行数に関する補足
    - GitHubはAPI（GraphQL）でプルリクエストに含まれる差分の追加行数と削除行数を取得できる
    - GitLabは直接追加行数と削除行数を取得するAPIは用意されていないため、差分を取得して算出する
    - GitBucketはAPIでも差分取得ができず、HTMLにも差分は書き出されず、JavaScriptを用いて差分を算出しているため、本ツールでは常に0を返す

#### 2行目以降

| 順番 | 項目名              | 説明                                                                                                                                                   |
| ---- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1    | `url`               | 指摘のURL                                                                                                                                              |
| 2    | `reviewComment`     | レビュー指摘事項。GitHubとGitLabはAPIで取得したマークダウン、GitBucketはAPIが使えないためHTMLをパースして得たテキスト。改行はエスケープして1行にする。 |
| 3    | `reviewer`          | レビュアーのユーザー名。                                                                                                                               |
| 4    | `revieweeComment`   | 対応内容。GitHubとGitLabはAPIで取得したマークダウン、GitBucketはAPIが使えないためHTMLをパースして得たテキスト。改行はエスケープして1行にする。         |
| 5    | `reviewee`          | レビュイーのユーザー名。                                                                                                                               |
| 6    | `resolved`          | APIで取得できる指摘の解決状態。GitHubの通常コメントと、GitBucketは指摘の解決状態を取得できないので`false`を返す。                                      |
| 7    | `hasResolvedStatus` | APIで指摘の解決状態を取得できる場合は`true`を返す。GitHubの通常コメントと、GitBucketは指摘の解決状態を取得できないので`false`を返す。                  |

指摘コメントの取得について、スレッド形式と非スレッド形式で次の通り加工方法が異なる。

- スレッド形式の場合
    - レビュアーとレビュイーのコメントをそれぞれ集約する
    - プルリクエスト（マージリクエスト）作成者をレビュイー、それ以外をレビュアーとみなす
    - スレッドにレビュアーのコメントが複数ある場合、2つ目以降のコメントには先頭に`post-script-prefix`を付ける（レビュイーのコメントも同様）
    - レビュアーのコメントとレビュイーのコメントを`delimiter`で繋ぐ
    - 改行をエスケープする
    - ここまでの加工を行なったものをCSVに書き出す
- 非スレッド形式の場合
    - 取得したコメントの改行をエスケープしてCSVに書き出す
